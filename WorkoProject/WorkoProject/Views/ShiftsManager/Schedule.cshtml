@using Entities

@model Entities.WorkSchedule

@{
    ViewBag.Title = "סידור עבודה לשבוע הקרוב";
    Layout = "~/Views/Shared/_ControlLayout.cshtml";
    var stations = ViewData["Stations"] as List<Station>;
    var shifts = Model.Template.Shifts;
    var contents = File.ReadAllText(Server.MapPath(Url.Content("~/Content/jewish-holidays-all.csv"))).Split('\n');
    var csv = from line in contents
              select line.Split(',').ToArray(); 
    int headerRows = 5;
    var csvArray = csv.Skip(headerRows).TakeWhile(r => r.Length > 1 && r.Last().Trim().Length > 0).ToArray();

    Dictionary<string, string> days = new Dictionary<string, string>();
    days.Add("Sunday", "ראשון");
    days.Add("Monday", "שני");
    days.Add("Tuesday", "שלישי");
    days.Add("Wednesday", "רביעי");
    days.Add("Thursday", "חמישי");
    days.Add("Friday", "שישי");
    days.Add("Saturday", "שבת");
    
    Dictionary<string, string> holidays = new Dictionary<string, string>();
    holidays.Add("Asara B'Tevet", "עשרה בטבת");
    holidays.Add("Rosh Chodesh Sh'vat", "ראש חודש שבט");
    holidays.Add("Tu BiShvat", "ט\"ו בשבט");
    holidays.Add("Shabbat Shekalim", "שבת שקלים");
    holidays.Add("Rosh Chodesh Adar", "ראש חודש אדר");
    holidays.Add("Shabbat Zachor", "שבת זכור");
    holidays.Add("Ta'anit Esther", "תענית אסתר");
    holidays.Add("Erev Purim", "ערב פורים");
    holidays.Add("Purim", "פורים");
    holidays.Add("Shushan Purim", "שושן פורים");
    holidays.Add("Shabbat Parah", "שבת פרה");
    holidays.Add("Rosh Chodesh Nisan", "ראש חודש ניסן");
    holidays.Add("Shabbat HaChodesh", "שבת הקודש");
    holidays.Add("Shabbat HaGadol", "שבת הגדול");
    holidays.Add("Ta'anit Bechorot", "תענית בכורות");
    holidays.Add("Erev Pesach", "ערב פסח");
    holidays.Add("Pesach I", "פסח יום א׳");
    holidays.Add("Pesach II", "פסח יום ב׳");
    holidays.Add("Pesach III (CH''M)", "פסח יום ג׳ (חל המועד)");
    holidays.Add("Pesach IV (CH''M)", "פסח יום ד׳ (חל המועד)");
    holidays.Add("Pesach V (CH''M)", "פסח יום ה׳ (חל המועד)");
    holidays.Add("Pesach VI (CH''M)", "פסח יום ו׳ (חל המועד)");
    holidays.Add("Pesach VII", "פסח יום ז׳");
    holidays.Add("Pesach VIII", "פסח יום ח׳");
    holidays.Add("Yom HaShoah", "יום השואה");
    holidays.Add("Rosh Chodesh Iyyar", "ראש חודש אייר");
    holidays.Add("Yom HaZikaron", "יום הזכרון");
    holidays.Add("Yom HaAtzma'ut", "יום העצמאות");
    holidays.Add("Pesach Sheni", "פסח שני");
    holidays.Add("Lag B'Omer", "ל\"ג בעומר");
    holidays.Add("Yom Yerushalayim", "יום ירושלים");
    holidays.Add("Rosh Chodesh Sivan", "ראש חודש סיון");
    holidays.Add("Erev Shavuot", "ערב שבועות");
    holidays.Add("Shavuot I", "שבועות יום א׳");
    holidays.Add("Shavuot II", "שבועות יום ב׳");
    holidays.Add("Rosh Chodesh Tamuz", "ראש חודש תמוז");
    holidays.Add("Tzom Tammuz", "צום תמוז");
    holidays.Add("Rosh Chodesh Av", "ראש חודש אב");
    holidays.Add("Shabbat Chazon", "שבת חזון");
    holidays.Add("Erev Tish'a B'Av", "ערב תשעה באב");
    holidays.Add("Tish'a B'Av", "תשעה באב");
    holidays.Add("Shabbat Nachamu", "שבת נחמו");
    holidays.Add("Rosh Chodesh Elul", "ראש חודש אלול");
    holidays.Add("Leil Selichot", "ליל סליחות");
    holidays.Add("Erev Rosh Hashana", "ערב ראש השנה");
    holidays.Add("Rosh Hashana 5776", "ראש השנה");
    holidays.Add("Rosh Hashana II", "ראש השנה");
    holidays.Add("Tzom Gedaliah", "צום גדליה");
    holidays.Add("Shabbat Shuva", "שבת שובה");
    holidays.Add("Erev Yom Kippur", "ערב יום כיפור");
    holidays.Add("Yom Kippur", "יום כיפור");
    holidays.Add("Erev Sukkot", "ערב סוכות");
    holidays.Add("Sukkot I", "סוכות יום א׳");
    holidays.Add("Sukkot II", "סוכות יום ב׳");
    holidays.Add("Sukkot III (CH''M)", "סוכות יום ג׳ (חל המועד)");
    holidays.Add("Sukkot IV (CH''M)", "סוכות יום ד׳ (חל המועד)");
    holidays.Add("Sukkot V (CH''M)", "סוכות יום ה׳ (חל המועד)");
    holidays.Add("Sukkot VI (CH''M)", "סוכות יום ו׳ (חל המועד)");
    holidays.Add("Sukkot VII (Hoshana Raba)", "סוכות יום ז׳ (הושנא רבה)");
    holidays.Add("Shmini Atzeret", "שמיני עצרת");
    holidays.Add("Simchat Torah", "שמחת תורה");
    holidays.Add("Rosh Chodesh Cheshvan", "ראש חודש חשון");
    holidays.Add("Rosh Chodesh Kislev", "ראש חודש כסלו");
    holidays.Add("Chanukah: 1 Candle", "חנוכה נר ראשון");
    holidays.Add("Chanukah: 2 Candles", "חנוכה נר שני");
    holidays.Add("Chanukah: 3 Candles", "חנוכה נר שלישי");
    holidays.Add("Chanukah: 4 Candles", "חנוכה נר רביעי");
    holidays.Add("Chanukah: 5 Candles", "חנוכה נר חמישי");
    holidays.Add("Chanukah: 6 Candles", "חנוכה נר שישי");
    holidays.Add("Chanukah: 7 Candles", "חנוכה נר שביעי");
    holidays.Add("Chanukah: 8 Candles", "חנוכה נר שמיני");
    holidays.Add("Chanukah: 8th Day", "חנוכה יום שמיני");
    holidays.Add("Rosh Chodesh Tevet", "ראש חודש טבת");
}

<h2>סידור עבודה</h2>

<div id="work-schedule" class="row schedule-table">
    <div class="panel-heading">
        @using (Html.BeginForm("CreateWeeklySchedule", "ShiftsManager", FormMethod.Post))
        {
            <button type="submit" class="btn btn-success pull-left" data-tooltip="tooltip" data-placement="top" title="שמור סידור עבודה">שמור סידור עבודה</button>

        }
    </div>

    <div class="table-responsive">
        <table class="table table-bordered">
            <thead>
                <tr>
                    <th style="vertical-align: middle;">עמדה</th>
                    @DayOfWeek(csvArray, holidays, days)
                </tr>
            </thead>
            <tbody>
                <tr class="day"><td colspan="8"><div>בוקר</div></td></tr>
                @PlaceWorkers(stations, shifts, 0)
                <tr class="day"><td colspan="8"><div>צהריים</div></td></tr>
                @PlaceWorkers(stations, shifts, 7)
                <tr class="day"><td colspan="8"><div>לילה</div></td></tr>
                @PlaceWorkers(stations, shifts, 14)
            </tbody>
        </table>
    </div>
</div>


@helper DayOfWeek(string[][] csvArray, Dictionary<string, string> holidays, Dictionary<string, string> days)
{
    for (int i = 0; i < 7; i++)
    {
        string day = days[Enum.GetName(typeof(DayOfWeek), Convert.ToInt32(i))];
        
        <th>
            <div>
                <span>@day</span>
                <span>@Model.StartDate.AddDays(i).ToString("dd/MM/yyyy")</span>
                <span class="holiday-name text-muted">
                    @{
                        var date = Model.StartDate.AddDays(i).ToString("M/d/yyyy");
                        foreach (var row in csvArray)
                        {
                            if (row[1].Split('\"')[1].Equals(date))
                            {
                                @holidays[row[0].Split('\"')[1]];
                                break;
                            }
                        }
                    }
                </span>
            </div>
        </th>
    }
}

@helper PlaceWorkers(List<Station> stations, Shift[] shifts, int shiftTime)
{
    foreach (var station in stations)
    {
        <tr>
            <td>@station.Name</td>
            @for (int i = shiftTime; i < 7 + shiftTime; i++)
            {
                List<Worker> workers = null;
                var s = shifts[i].Stations.Find(x => x.Id == station.Id);
                try
                {
                    workers = s.Workers;
                }
                catch { }
                bool hasWorkers = workers != null && workers.Count > 0;
                bool isActive = shifts[i].IsActive && (s != null && s.Status == StationStatus.Active);
                <td class="@(!isActive ? "not-active" : string.Empty) @(hasWorkers ? string.Empty : "no-workers")">
                    @if (hasWorkers)
                    {
                        <ul>
                            @foreach (var w in workers)
                            {
                                <li>@w.FirstName @w.LastName</li>
                            }
                        </ul>
                    }
                </td>
            }
        </tr>
    }
}
